<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Background Remover & Changer - Time Saving Tools</title>
    <!-- TensorFlow.js and BodyPix model -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.0/dist/body-pix.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif; background-color: #333; color: #f4f4f4;
            margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh;
        }
        .tool-container {
            width: 90%; max-width: 900px; /* Wider for image previews and controls */
            margin: 30px auto; padding: 30px; background-color: #444;
            border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.55); flex-grow: 1;
        }
        .tool-header {
            background: #222; color: #fff; padding: 1rem 0; border-bottom: 3px solid #FFD700;
            text-align: center; margin-bottom: 25px;
        }
        .tool-header h1 a { color: #FFD700; text-decoration: none; font-size: 1.8em; }
        .tool-header .breadcrumb { margin-top: 5px; font-size: 0.9em; }
        .tool-header .breadcrumb a { color: #ccc; text-decoration: none; }
        .tool-header .breadcrumb a:hover { color: #FFD700; }

        .tool-container h2 { color: #FFD700; text-align: center; margin-bottom: 2rem; font-size: 2em; }
        .form-group { margin-bottom: 1.8rem; }
        .form-group label { display: block; margin-bottom: 0.6rem; color: #f0f0f0; font-weight: bold; font-size: 1.05em; }

        input[type="file"] {
            width: 100%; padding: 14px; border-radius: 6px; border: 1px solid #555;
            background-color: #3a3a3a; color: #f4f4f4; font-size: 1em; box-sizing: border-box;
        }
        input[type="file"]::-webkit-file-upload-button {
            background-color: #FFD700; color: #333; border: none; padding: 12px 18px;
            border-radius: 5px; cursor: pointer; font-weight: bold; margin-right: 12px;
            transition: background-color 0.3s ease; font-size: 0.95em;
        }
        input[type="file"]::-webkit-file-upload-button:hover { background-color: #e6b800; }
        input[type="file"] { color: #ccc; }

        .controls-area {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 1.5rem;
            padding: 15px;
            background-color: #3a3a3a;
            border-radius: 8px;
        }
        .control-group { flex: 1; min-width: 200px; }
        .control-group label { font-size: 1em; }
        input[type="color"] {
            width: 100%;
            height: 40px;
            border: 1px solid #555;
            border-radius: 5px;
            cursor: pointer;
            padding: 0; /* Remove default padding */
        }
        /* Custom appearance for color input */
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 4px; }
        
        .preset-colors { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
        .color-button {
            width: 30px; height: 30px; border-radius: 50%; border: 2px solid #555;
            cursor: pointer; transition: transform 0.2s;
        }
        .color-button:hover { transform: scale(1.1); }
        .color-button.active { border-color: #FFD700; box-shadow: 0 0 5px #FFD700;}


        /* Buttons are already large */
        .action-buttons button {
            background-color: #FFD700; color: #333; border: none; padding: 1rem 1.5rem; /* Adjusted padding */
            font-size: 1.1em; font-weight: bold; border-radius: 6px; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: inline-flex; align-items: center; gap: 10px;
            margin: 5px; min-width: 180px; justify-content: center;
        }
        .action-buttons button:hover { background-color: #e6b800; transform: translateY(-2px); }
        .action-buttons button:disabled { background-color: #555; color: #888; cursor: not-allowed; transform: none; }
        .action-buttons button .fas { font-size: 1.1em; }
        .button-group { text-align: center; margin-top: 2rem; }


        #loadingIndicator { display: none; text-align: center; margin: 20px 0; font-size: 1.1em; color: #FFD700; }
        #loadingIndicator .fas { margin-right: 10px; animation: fa-spin 2s infinite linear; }
        @keyframes fa-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .image-preview-area {
            display: flex;
            gap: 20px;
            margin-top: 2rem;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            justify-content: space-around;
        }
        .image-box {
            background-color: #2c2c2c;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #505050;
            flex-basis: 45%; /* Try to fit two side-by-side */
            min-width: 300px; /* Minimum width */
        }
        .image-box h4 { margin-top: 0; margin-bottom: 10px; color: #FFD700; }
        .image-box canvas, .image-box img {
            max-width: 100%;
            height: auto;
            max-height: 350px;
            border-radius: 4px;
            display: block;
            margin: 0 auto;
            background-color: #FFF; /* Light background for transparent areas to be visible */
            /* Checkerboard pattern for transparency */
            background-image: 
                linear-gradient(45deg, #ccc 25%, transparent 25%), 
                linear-gradient(-45deg, #ccc 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #ccc 75%),
                linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size:20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }


        .status-message { text-align: center; margin-top: 1.5rem; padding: 14px; border-radius: 5px; font-weight: bold; font-size: 1.05em;}
        .status-message.error { background-color: #D32F2F; color: white; }
        .status-message.info { background-color: #1976D2; color: white; }
        .status-message.warning { background-color: #FFA000; color: #333; }

        .tool-footer { background: #222; color: #ccc; text-align: center; padding: 1rem 0; font-size: 0.9em; border-top: 2px solid #FFD700; margin-top: auto;}
        .tool-footer a { color: #FFD700; text-decoration: none; }
        .tool-footer a:hover { text-decoration: underline; }

    </style>
</head>
<body>

    <header class="tool-header">
        <h1><a href="../index.html">Time Saving Tools</a></h1>
        <div class="breadcrumb">
            <a href="../index.html">Home</a> > <a href="../index.html#image-tools-section">Image Tools</a> > <span>Background Remover</span>
        </div>
    </header>

    <div class="tool-container">
        <h2><i class="fas fa-user-ninja"></i> Image Background Remover & Changer</h2>
        <p style="text-align:center; font-size:0.9em; color:#ccc; margin-bottom:1.5rem;">
            एक इमेज अपलोड करें, खासकर जिसमें व्यक्ति हों। यह टूल व्यक्ति को डिटेक्ट करके बैकग्राउंड हटाने की कोशिश करेगा।
            <br>ध्यान दें: यह क्लाइंट-साइड टूल है और AI सर्वर-साइड टूल जितना सटीक नहीं हो सकता।
        </p>

        <div class="form-group">
            <label for="imageUpload"><i class="fas fa-upload"></i> इमेज अपलोड करें:</label>
            <input type="file" id="imageUpload" accept="image/png, image/jpeg, image/webp">
        </div>
        
        <div id="loadingIndicator">
            <i class="fas fa-spinner"></i> मॉडल लोड हो रहा है या इमेज प्रोसेस हो रही है...
        </div>
        <div id="statusMessage" class="status-message" style="display: none;"></div>

        <div class="controls-area" style="display:none;" id="processingControls">
            <div class="control-group">
                <label for="bgColorPicker"><i class="fas fa-palette"></i> नया बैकग्राउंड कलर चुनें:</label>
                <input type="color" id="bgColorPicker" value="#FFFFFF">
                <div class="preset-colors">
                    <button class="color-button" data-color="#FFFFFF" title="सफेद" style="background-color:#FFFFFF;"></button>
                    <button class="color-button" data-color="#000000" title="काला" style="background-color:#000000;"></button>
                    <button class="color-button" data-color="#007bff" title="नीला" style="background-color:#007bff;"></button>
                    <button class="color-button" data-color="#FFD700" title="पीला" style="background-color:#FFD700;"></button>
                    <button class="color-button" data-color="#28a745" title="हरा" style="background-color:#28a745;"></button>
                    <button class="color-button" data-color="#dc3545" title="लाल" style="background-color:#dc3545;"></button>
                    <button class="color-button" data-color="transparent" title="पारदर्शी" style="background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size:10px 10px; background-position: 0 0, 0 5px, 5px -5px, -5px 0px;"></button>
                </div>
            </div>
             <div class="control-group action-buttons">
                <label style="margin-bottom:10px; display:block;">एक्शन:</label>
                <button id="removeBgBtn" disabled><i class="fas fa-magic"></i> बैकग्राउंड हटाएं</button>
                <button id="applyBgBtn" disabled><i class="fas fa-fill-drip"></i> कलर बैकग्राउंड लगाएं</button>
            </div>
        </div>
        
        <div class="image-preview-area">
            <div class="image-box" id="originalImageBox" style="display:none;">
                <h4><i class="fas fa-image"></i> ओरिजिनल इमेज</h4>
                <img id="originalImage" src="#" alt="Original Image">
            </div>
            <div class="image-box" id="processedImageBox" style="display:none;">
                <h4><i class="fas fa-sparkles"></i> प्रोसेस्ड इमेज</h4>
                <canvas id="outputCanvas"></canvas>
            </div>
        </div>

        <div class="button-group">
             <button id="downloadBtn" style="display:none;"><i class="fas fa-download"></i> इमेज डाउनलोड करें</button>
        </div>

    </div>

    <footer class="tool-footer">
        <p>© <span id="currentYearFooter"></span> <a href="../index.html">Time Saving Tools</a>. All Rights Reserved.</p>
    </footer>

    <script>
        document.getElementById('currentYearFooter').textContent = new Date().getFullYear();

        const imageUpload = document.getElementById('imageUpload');
        const originalImage = document.getElementById('originalImage');
        const outputCanvas = document.getElementById('outputCanvas');
        const ctx = outputCanvas.getContext('2d');

        const removeBgBtn = document.getElementById('removeBgBtn');
        const applyBgBtn = document.getElementById('applyBgBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const bgColorPicker = document.getElementById('bgColorPicker');
        
        const loadingIndicator = document.getElementById('loadingIndicator');
        const statusMessageDiv = document.getElementById('statusMessage');
        
        const originalImageBox = document.getElementById('originalImageBox');
        const processedImageBox = document.getElementById('processedImageBox');
        const processingControls = document.getElementById('processingControls');
        
        const presetColorButtons = document.querySelectorAll('.preset-colors .color-button');

        let bodyPixNet = null;
        let uploadedImageElement = null; // Will hold the loaded image HTML element
        let currentSegmentation = null;

        // Load BodyPix model
        async function loadModel() {
            showLoading('BodyPix मॉडल लोड हो रहा है...');
            try {
                bodyPixNet = await bodyPix.load({
                    architecture: 'MobileNetV1', // or 'ResNet50'
                    outputStride: 16,
                    multiplier: 0.75, // or 1.0 or 0.50
                    quantBytes: 2 // or 4
                });
                showStatus('मॉडल सफलतापूर्वक लोड हो गया। इमेज अपलोड करें।', 'info');
            } catch (error) {
                console.error("BodyPix मॉडल लोड करने में त्रुटि:", error);
                showStatus('BodyPix मॉडल लोड करने में त्रुटि। कृपया पेज रीलोड करें।', 'error');
            } finally {
                hideLoading();
            }
        }
        loadModel(); // Load model on page load

        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    originalImage.src = e.target.result;
                    originalImage.style.display = 'block';
                    originalImageBox.style.display = 'block';
                    processingControls.style.display = 'flex';
                    processedImageBox.style.display = 'none'; // Hide previous result
                    downloadBtn.style.display = 'none';
                    removeBgBtn.disabled = false;
                    applyBgBtn.disabled = true; // Disabled until BG is removed
                    currentSegmentation = null; // Reset segmentation

                    // Create an HTMLImageElement for bodypix processing
                    uploadedImageElement = new Image();
                    uploadedImageElement.onload = () => {
                         // console.log('Image element loaded for processing');
                         showStatus('इमेज लोड हो गई। बैकग्राउंड हटाने के लिए "बैकग्राउंड हटाएं" पर क्लिक करें।', 'info');
                    };
                    uploadedImageElement.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        removeBgBtn.addEventListener('click', async () => {
            if (!bodyPixNet || !uploadedImageElement) {
                showStatus('मॉडल लोड नहीं हुआ या कोई इमेज नहीं चुनी गई है।', 'warning');
                return;
            }
            showLoading('बैकग्राउंड हटाया जा रहा है...');
            removeBgBtn.disabled = true;
            applyBgBtn.disabled = true;

            try {
                // Perform segmentation
                currentSegmentation = await bodyPixNet.segmentPerson(uploadedImageElement, {
                    flipHorizontal: false,
                    internalResolution: 'medium', // 'low', 'medium', 'high', 'full'
                    segmentationThreshold: 0.7 // 0.0 to 1.0
                });

                if (!currentSegmentation || currentSegmentation.data.every(p => p === 0)) {
                    showStatus('कोई व्यक्ति डिटेक्ट नहीं हुआ या सेगमेंटेशन खाली है। यह टूल व्यक्तियों के लिए बेहतर काम करता है।', 'warning');
                    processedImageBox.style.display = 'none';
                    currentSegmentation = null; // Invalidate if no person
                } else {
                    // Draw with transparent background by default
                    drawWithBackgroundColor(null); // null for transparent
                    showStatus('बैकग्राउंड हटा दिया गया है। अब आप नया कलर बैकग्राउंड लगा सकते हैं।', 'info');
                    processedImageBox.style.display = 'block';
                    applyBgBtn.disabled = false; // Enable apply color button
                    downloadBtn.style.display = 'inline-flex';
                }
            } catch (error) {
                console.error("सेगमेंटेशन त्रुटि:", error);
                showStatus('बैकग्राउंड हटाने में त्रुटि हुई।', 'error');
            } finally {
                hideLoading();
                removeBgBtn.disabled = false; // Re-enable remove bg button
            }
        });
        
        applyBgBtn.addEventListener('click', () => {
            if (!currentSegmentation || !uploadedImageElement) {
                 showStatus('पहले "बैकग्राउंड हटाएं" का उपयोग करें।', 'warning');
                return;
            }
            const bgColor = bgColorPicker.value;
            drawWithBackgroundColor(bgColor === 'transparent' ? null : bgColor);
            showStatus(`"${bgColor === 'transparent' ? 'पारदर्शी' : bgColor}" बैकग्राउंड लगाया गया।`, 'info');
        });

        function drawWithBackgroundColor(bgColor) {
            if (!uploadedImageElement || !currentSegmentation) return;

            const { width, height } = uploadedImageElement;
            outputCanvas.width = width;
            outputCanvas.height = height;

            const fgOpacity = 1;
            const bgBlurAmount = 0; // No background blur
            const edgeBlurAmount = 2; // Slight edge blur for smoother transition
            
            // This draws the image with specified background color (or transparent if null)
            // It uses segmentation mask: 0 for background, 1 for person
            // bodyPix.toMask is a utility but here we use drawMask
             const backgroundDarkeningMask = bodyPix.toMask(
                currentSegmentation, {r: 0, g: 0, b: 0, a: 0}, {r: 0, g: 0, b: 0, a: 255},
                true);
            
            ctx.clearRect(0,0, width, height);

            if (bgColor) { // If a background color is specified
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, width, height);
            }
            
            // Draw the person (foreground)
            // Composite operation to "cut out" the person and draw them.
            // We'll draw the original image, then use the mask to keep only the person.
            ctx.globalCompositeOperation = 'destination-out'; // Will erase parts where new content is drawn
            // First, fill the canvas based on inverted mask.
            // (Areas that are background in the mask become opaque, person becomes transparent)
            // This requires creating an offscreen canvas for the mask if we want to fill complex shapes.

            // Simpler method: draw image, then "punch out" background
            ctx.globalCompositeOperation = 'source-over'; // Default
            if (bgColor) {
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, width, height);
            } else {
                // If transparent, ensure canvas is clear. Handled by clearRect initially.
            }


            // Draw original image to an offscreen canvas
            const offscreenCanvas = document.createElement('canvas');
            offscreenCanvas.width = width;
            offscreenCanvas.height = height;
            const offscreenCtx = offscreenCanvas.getContext('2d');
            offscreenCtx.drawImage(uploadedImageElement, 0, 0);
            const imageData = offscreenCtx.getImageData(0, 0, width, height);
            const data = imageData.data;

            // Apply mask
            for (let i = 0; i < currentSegmentation.data.length; i++) {
                // If the pixel is part of the background (mask value 0), make it transparent
                if (currentSegmentation.data[i] === 0) {
                    data[i * 4 + 3] = 0; // Alpha channel to 0 (transparent)
                }
            }
            offscreenCtx.putImageData(imageData, 0, 0);

            // Draw the masked foreground onto the main canvas
            ctx.drawImage(offscreenCanvas, 0, 0);
            
            // Reset composite operation if changed for other drawing
            ctx.globalCompositeOperation = 'source-over';
        }
        
        bgColorPicker.addEventListener('input', (event) => {
            const color = event.target.value;
            setActiveColorButton(null); // Deselect preset if color picker used
            // Auto-apply if segmentation exists (optional)
            // if (currentSegmentation && applyBgBtn.disabled === false) {
            //     drawWithBackgroundColor(color);
            // }
        });
        
        presetColorButtons.forEach(button => {
            button.addEventListener('click', () => {
                const color = button.dataset.color;
                bgColorPicker.value = (color === 'transparent' || color === null) ? '#000000' : color; // Picker can't show transparent
                setActiveColorButton(button);
                 if (currentSegmentation && applyBgBtn.disabled === false) { // Auto-apply only if remove bg has run
                     drawWithBackgroundColor(color === 'transparent' ? null : color);
                     showStatus(`"${color === 'transparent' ? 'पारदर्शी' : color}" बैकग्राउंड चुना गया।`, 'info');
                 } else if (!currentSegmentation){
                     showStatus(`"${color === 'transparent' ? 'पारदर्शी' : color}" बैकग्राउंड चुना गया। पहले "बैकग्राउंड हटाएं"।`, 'info');
                 }
            });
        });

        function setActiveColorButton(activeButton) {
            presetColorButtons.forEach(btn => btn.classList.remove('active'));
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }


        downloadBtn.addEventListener('click', () => {
            if (processedImageBox.style.display === 'none' || !outputCanvas.width) {
                showStatus('पहले इमेज प्रोसेस करें।', 'warning');
                return;
            }
            const imageName = (uploadedImageElement.name || 'processed_image') + '.png'; // Always download as PNG for transparency
            const dataURL = outputCanvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = imageName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showStatus('इमेज डाउनलोड हो रही है...', 'info');
        });


        function showLoading(message) {
            loadingIndicator.textContent = message || 'प्रोसेस हो रहा है...';
            loadingIndicator.style.display = 'block';
            statusMessageDiv.style.display = 'none';
        }
        function hideLoading() {
            loadingIndicator.style.display = 'none';
        }
        function showStatus(message, type = 'info') {
            statusMessageDiv.textContent = message;
            statusMessageDiv.className = 'status-message ' + type;
            statusMessageDiv.style.display = 'block';
        }

    </script>

</body>
  </html>
